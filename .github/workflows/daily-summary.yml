name: Daily CI Summary

on:
  schedule:
    # Try at 8 AM, 12 PM, and 4 PM UTC
    # Send once per day - first successful attempt wins
    - cron: '0 8 * * *'
    - cron: '0 12 * * *'
    - cron: '0 16 * * *'
  
  workflow_dispatch:
    # Manual trigger for testing
    inputs:
      force:
        description: 'Force send even if already sent today'
        type: boolean
        default: false

jobs:
  daily-summary:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout dashboard repo
        uses: actions/checkout@v4
      
      - name: Get today's date
        id: date
        run: |
          TODAY=$(date -u '+%Y-%m-%d')
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          echo "Today is: $TODAY"
      
      - name: Check if already sent today
        id: check-sent
        uses: actions/cache@v4
        with:
          path: .slack-sent-marker
          key: slack-daily-summary-${{ steps.date.outputs.today }}
          lookup-only: true
      
      - name: Skip if already sent today
        if: steps.check-sent.outputs.cache-hit == 'true' && github.event.inputs.force != 'true'
        run: |
          echo "âœ… Already sent notification for ${{ steps.date.outputs.today }}, skipping"
          echo "Use 'force' option in manual trigger to send anyway"
      
      - name: Check if nightly ran today
        id: check-nightly
        if: steps.check-sent.outputs.cache-hit != 'true' || github.event.inputs.force == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking if nightly workflow ran today..."
          
          TODAY="${{ steps.date.outputs.today }}"
          
          # Check for completed nightly runs that started today
          NIGHTLY_RUN=$(gh api repos/kata-containers/kata-containers/actions/workflows/ci-nightly.yaml/runs \
            -q ".workflow_runs[] | select(.created_at | startswith(\"$TODAY\")) | select(.status == \"completed\") | .id" | head -1)
          
          if [ -z "$NIGHTLY_RUN" ]; then
            echo "â³ No completed nightly run found for today ($TODAY)"
            echo "Will retry at next scheduled time"
            echo "nightly_ran=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Found completed nightly run: $NIGHTLY_RUN"
            echo "nightly_ran=true" >> $GITHUB_OUTPUT
            echo "run_id=$NIGHTLY_RUN" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Node.js
        if: (steps.check-sent.outputs.cache-hit != 'true' || github.event.inputs.force == 'true') && steps.check-nightly.outputs.nightly_ran == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        if: (steps.check-sent.outputs.cache-hit != 'true' || github.event.inputs.force == 'true') && steps.check-nightly.outputs.nightly_ran == 'true'
        run: npm install js-yaml
      
      - name: Generate summary
        if: (steps.check-sent.outputs.cache-hit != 'true' || github.event.inputs.force == 'true') && steps.check-nightly.outputs.nightly_ran == 'true'
        id: summary
        run: |
          node scripts/generate-summary.js > summary.json
          cat summary.json
          
          # Extract key stats for the message
          echo "pass_rate=$(jq -r '.overall_pass_rate' summary.json)" >> $GITHUB_OUTPUT
          echo "total=$(jq -r '.total_tests' summary.json)" >> $GITHUB_OUTPUT
          echo "failed=$(jq -r '.failed_count' summary.json)" >> $GITHUB_OUTPUT
          echo "not_run=$(jq -r '.not_run_count' summary.json)" >> $GITHUB_OUTPUT
          echo "passed=$(jq -r '.passed_count' summary.json)" >> $GITHUB_OUTPUT
      
      - name: Send Slack notification
        if: (steps.check-sent.outputs.cache-hit != 'true' || github.event.inputs.force == 'true') && steps.check-nightly.outputs.nightly_ran == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Skip if no webhook configured
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "No SLACK_WEBHOOK_URL secret configured, skipping notification"
            exit 0
          fi
          
          # Calculate status emoji
          pass_rate=${{ steps.summary.outputs.pass_rate }}
          if [ "$pass_rate" -ge 95 ]; then
            status_emoji="â˜€ï¸"
            status_text="Excellent"
          elif [ "$pass_rate" -ge 85 ]; then
            status_emoji="ðŸŒ¤ï¸"
            status_text="Good"
          elif [ "$pass_rate" -ge 70 ]; then
            status_emoji="â›…"
            status_text="Fair"
          elif [ "$pass_rate" -ge 50 ]; then
            status_emoji="ðŸŒ§ï¸"
            status_text="Needs Attention"
          else
            status_emoji="â›ˆï¸"
            status_text="Critical"
          fi
          
          # Build section breakdown (only show groups with failures or not_run)
          sections_text=$(jq -r '
            .sections | 
            map(select(.failed > 0 or .not_run > 0)) |
            if length == 0 then "All groups passing! ðŸŽ‰"
            else map("â€¢ *\(.name)*: \(.weather_emoji) \(.pass_rate)% (ðŸ”´ \(.failed) | ðŸŸ¡ \(.not_run // 0))") | join("\\n")
            end
          ' summary.json)
          
          # Build failing tests list (all failures) with maintainer mentions and specific failures
          failing_tests=$(jq -r '
            .failing_tests | 
            if length == 0 then "None! ðŸŽ‰" 
            else map(
              "â€¢ `\(.name)` - \(.error_step) (\(.days_failing)d)" + 
              (if .slack_mentions != "" then " â†’ \(.slack_mentions)" else "" end) +
              (if (.specific_failures | length) > 0 then "\\n    _" + (.specific_failures | join(", ")) + "_" else "" end)
            ) | join("\\n") 
            end
          ' summary.json)
          
          # Build flaky tests list (top 3)
          flaky_tests=$(jq -r '
            .flaky_tests[:3] | 
            if length == 0 then "None detected" 
            else map("â€¢ `\(.name)` - \(.flaky_rate)% flaky") | join("\\n") 
            end
          ' summary.json)
          
          # Send to Slack webhook
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${status_emoji} Kata CI Nightly Summary",
                  "emoji": true
                }
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "$(date -u '+%A, %B %d, %Y') â€¢ <https://kata-containers.github.io/kata-ci-dashboard/|Open Dashboard>"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Pass Rate*\n${status_emoji} ${pass_rate}%"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Status*\n${status_text}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Tests*\n${{ steps.summary.outputs.total }} total"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Results*\nðŸŸ¢ ${{ steps.summary.outputs.passed }} | ðŸ”´ ${{ steps.summary.outputs.failed }} | ðŸŸ¡ ${{ steps.summary.outputs.not_run }}"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ðŸ“Š By Section*\n${sections_text}"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ðŸ”´ Failing Tests (top 5)*\n${failing_tests}"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*âš¡ Flaky Tests (top 3)*\n${flaky_tests}"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "ðŸ“Š Open Dashboard",
                      "emoji": true
                    },
                    "url": "https://kata-containers.github.io/kata-ci-dashboard/",
                    "style": "primary"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "ðŸ”§ GitHub Actions",
                      "emoji": true
                    },
                    "url": "https://github.com/kata-containers/kata-containers/actions/workflows/ci-nightly.yaml"
                  }
                ]
              }
            ]
          }
          EOF
          
          echo "âœ… Slack notification sent!"
      
      - name: Create sent marker
        if: (steps.check-sent.outputs.cache-hit != 'true' || github.event.inputs.force == 'true') && steps.check-nightly.outputs.nightly_ran == 'true'
        run: |
          echo "Sent notification for ${{ steps.date.outputs.today }} at $(date -u)" > .slack-sent-marker
      
      - name: Save sent marker to cache
        if: (steps.check-sent.outputs.cache-hit != 'true' || github.event.inputs.force == 'true') && steps.check-nightly.outputs.nightly_ran == 'true'
        uses: actions/cache/save@v4
        with:
          path: .slack-sent-marker
          key: slack-daily-summary-${{ steps.date.outputs.today }}
